<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client by LUKCAD</title>
    <style>
        h3 {
            color: green;
        }

        .container {
            margin: 5px;
        }

        div.topRow {
            width:100%;
            clear:both;
        }
        div.leftCol {
            width:50%;
            float:left;
        }
        div.rightCol {
            width:50%;
            float:right;
        }
        input {
            width: 100%;
        }
        textarea {
            width: 100%;
        }

        .btn {
            background-color: DodgerBlue;
            border: none;
            color: white;
            padding: 4px 4px;
            font-size: 12px;
            cursor: pointer;

        }

            /* Darker background on mouse-over */
            .btn:hover {
            background-color: RoyalBlue;
        }
        div.histTop {
            width:100%;
            clear:both;
        }
        div.histText {
            width:90%;
            float:left;

        }
        div.histBtn {

            float:right;
            
    
        }
    </style>
</head>

<body>
    
    <div class="container">
        <h3>WebSocket Client</h3>
        <label>WS Server to interact with messages:</label></br><input type="text" id="nameServer" value="wss://echo.websocket.org" /> </br>
        <label>Message:</label></br><textarea rows = "5"  id="messageInput"></textarea></br>
        <button class="btn" onclick="sendMessage()">Send</button>
		<button class="btn" onclick="closeConnect()">Disconnect</button>
		<button class="btn" onclick="reConnect()">Reconnect</button>
        <button class="btn" onclick="clearScreen()">Clean Messages</button>
 
        <div class="main">
            <div class="topRow"></div>
            <div class="leftCol">Messages:</div>
            <div class="rightCol">History of sending unical messages:</div>
        <div>
        <div class="main">
            <div class="topRow"></div>
            <div id="output" class="leftCol"></div>
            <div id="history" class="rightCol"></div>
        <div>            
    </div>

    <script>
        // Create a WebSocket instance
        // and connect to the server
        var socket;
		var wsUri;


        var json_str = localStorage.getItem("wsmshistory")? localStorage.getItem("wsmshistory") : '[]';
        var arrraw = JSON.parse(json_str);
        var arr = [];

        for (let index = 0; index < arrraw.length; index++) {
            const element = arrraw[index];
            if (element !== null){
                arr.push(element);
            }
            
        }
            
        //}
        

        function reloadHistory() {
            arr.forEach((item) => {
            console.log(item);
            writeToHistory(`${item}`, 'brown');
        })
        }


		
		function reConnect() {
		
			 wsUri = document.getElementById("nameServer").value;
			 socket = new WebSocket(wsUri);
			
			 socket.onopen = function(evt) {
				onOpen(evt)
			 };
			
			 socket.onclose = function(evt) {
				onClose(evt)
			 };
			
			 socket.onmessage = function(evt) {
				onMessage(evt)
			 };
			
			 socket.onerror = function(evt) {
				onError(evt)
			 };
		}

        // Event listener for when 
        //the WebSocket connection is opened
        onOpen = function (event) {
            // Write message that users is 
            // connected to the WebSocket server
            writeToScreen('You are Connected to WebSocket Server', 'green');
        };

        // Event listener for when a message
        //  is received from the server
        onMessage = function (event) {
            writeToScreen(`Response message: ${event.data}`, 'green');
        };

        // Event listener for when the 
        // WebSocket connection is closed
        onClose = function (event) {
            // Log a message when disconnected
            //  from the WebSocket server
            //console.log('Disconnected from WebSocket server');
			writeToScreen(`You are disconnected from WebSocket Server. Code: ${event.code} `, 'red');
        };

		// Event listener for when the 
		// WebSocket sending message had error
		onError = function (event) {
			writeToScreen(`It was error.`, 'red');
        };

        // Function to send a message
        //  to the WebSocket server
        function sendMessage() {
            // Get the message input element
            const messageInput = document
                .getElementById('messageInput');
            // Get the value of
            // the message input
            const message = messageInput.value;

			if (socket.readyState === WebSocket.OPEN) {
				// Send the message to 
				// the WebSocket server			
				socket.send(message);
				// and show what we sent
				writeToScreen(`Sent message: ${message}`, 'blue');
                
                if (arr.indexOf(message) < 0) {
                    arr.push(message);
                    var json_str = JSON.stringify(arr);
                    localStorage.setItem("wsmshistory", json_str);
                    writeToHistory(`${message}`, 'brown');
                }
               

                
			}
            // Clear the message input
            messageInput.value = '';
        }
		
        function closeConnect() {
			if (socket.readyState === WebSocket.OPEN) {
				socket.close();
			}
		}	

		function writeToScreen(message, color = 'black') {
			 var pre = document.createElement("p"); 
			 pre.style.wordWrap = "break-word"; 
			 pre.style.color = `${color}`;
			 pre.innerHTML = message; 
			 const outputDiv = document
                .getElementById('output');
			 outputDiv.appendChild(pre);
            
	    }

        function writeToHistory(message, color = 'black') {

            var histTop = document.createElement("div"); 
            histTop.style.wordWrap = "break-word"; 
            histTop.className = "histTop"; 
                       
			 var pre = document.createElement("p"); 
			 pre.style.wordWrap = "break-word"; 
			 pre.style.color = `${color}`;
			 pre.innerHTML = message; 
             pre.onclick = copyToMessage;

             var delbtn = document.createElement("button"); 
			 delbtn.className = "btn"; 
             delbtn.title = "Delete message from history";
             delbtn.onclick = delMessageFromHistory;
			 delbtn.innerHTML = "x"; 
              
            var histText = document.createElement("div"); 
            histText.className = "histText"; 
            histText.appendChild(pre);



            var preBtn = document.createElement("p"); 
            preBtn.style.wordWrap = "break-word"; 
            preBtn.appendChild(delbtn);

            var histBtn = document.createElement("div"); 
            histBtn.className = "histBtn";              
            histBtn.appendChild(preBtn); 

            histTop.append(histText, histBtn);

            const historyDiv = document
                .getElementById('history');
            historyDiv.appendChild(histTop);


            function copyToMessage(){
                var messageInput = document
                .getElementById('messageInput');
                messageInput.value = message;
            }

            function delMessageFromHistory() {
                if (arr.indexOf(message) >= 0) {
                    var indextoremove = arr.indexOf(message);
                    var newarr = [];
                    for (let index = 0; index < arr.length; index++) {
                        var element = arr[index];
                        if (indextoremove !== index) {
                            newarr.push(element);
                        }
                        
                    }
                    arr = newarr;
                    var json_str = JSON.stringify(arr);
                    
                    localStorage.setItem("wsmshistory", json_str);
                    historyDiv.innerHTML = '';
                    reloadHistory()

                }                
            }
	    }



        function clearScreen() {

             document.getElementById("output").innerHTML = "";
	    }



		
		reConnect()
        reloadHistory()

    </script>
</body>

</html>
