<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client by LUKCAD</title>
    <style>
        h1 {
            color: green;
        }

        .container {
            margin: 10px;
        }

        div.topRow {
            width:100%;
            clear:both;
        }
        div.leftCol {
            width:50%;
            float:left;
        }
        div.rightCol {
            width:50%;
            float:right;
        }
        input {
            width: 100%;
        }
        textarea {
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>WebSocket Client</h1>
    <div class="container">
        <label>WS Server to interact with messages:</label></br><input type="text" id="nameServer" value="wss://echo.websocket.org" /> <br>
        <label>Message:</label><br/><textarea rows = "5"  id="messageInput"></textarea></br>
        <button onclick="sendMessage()">Send</button>
		<button onclick="closeConnect()">Disconnect</button>
		<button onclick="reConnect()">Reconnect</button>
        <button onclick="clearScreen()">Clean Messages</button>
 
        <div class="main">
            <div class="topRow"></div>
            <div class="leftCol">Messages:</div>
            <div class="rightCol">History of sending unical messages:</div>
        <div>
        <div class="main">
            <div class="topRow"></div>
            <div id="output" class="leftCol"></div>
            <div id="history" class="rightCol"></div>
        <div>            
    </div>

    <script>
        // Create a WebSocket instance
        // and connect to the server
        var socket;
		var wsUri;

        var json_str = getCookie('mycookie')? getCookie('mycookie') : '[]';
        var arr = JSON.parse(json_str);

        

        arr.forEach((item) => {
            console.log(item);
            writeToHistory(`${item}`, 'brown');
        })
		
		function reConnect() {
		
			 wsUri = document.getElementById("nameServer").value;
			 socket = new WebSocket(wsUri);
			
			 socket.onopen = function(evt) {
				onOpen(evt)
			 };
			
			 socket.onclose = function(evt) {
				onClose(evt)
			 };
			
			 socket.onmessage = function(evt) {
				onMessage(evt)
			 };
			
			 socket.onerror = function(evt) {
				onError(evt)
			 };
		}

        // Event listener for when 
        //the WebSocket connection is opened
        onOpen = function (event) {
            // Write message that users is 
            // connected to the WebSocket server
            writeToScreen('You are Connected to WebSocket Server', 'green');
        };

        // Event listener for when a message
        //  is received from the server
        onMessage = function (event) {
            writeToScreen(`Response message: ${event.data}`, 'green');
        };

        // Event listener for when the 
        // WebSocket connection is closed
        onClose = function (event) {
            // Log a message when disconnected
            //  from the WebSocket server
            //console.log('Disconnected from WebSocket server');
			writeToScreen(`You are disconnected from WebSocket Server. Code: ${event.code} `, 'red');
        };

		// Event listener for when the 
		// WebSocket sending message had error
		onError = function (event) {
			writeToScreen(`It was error.`, 'red');
        };

        // Function to send a message
        //  to the WebSocket server
        function sendMessage() {
            // Get the message input element
            const messageInput = document
                .getElementById('messageInput');
            // Get the value of
            // the message input
            const message = messageInput.value;

			if (socket.readyState === WebSocket.OPEN) {
				// Send the message to 
				// the WebSocket server			
				socket.send(message);
				// and show what we sent
				writeToScreen(`Sent message: ${message}`, 'blue');
                
                if (arr.indexOf(message) < 0) {
                    arr.push(message);
                    var json_str = JSON.stringify(arr);
                    createCookie('mycookie', json_str, 99);
                    writeToHistory(`${message}`, 'brown');
                }
               

                
			}
            // Clear the message input
            messageInput.value = '';
        }
		
        function closeConnect() {
			if (socket.readyState === WebSocket.OPEN) {
				socket.close();
			}
		}	

		function writeToScreen(message, color = 'black') {
			 var pre = document.createElement("p"); 
			 pre.style.wordWrap = "break-word"; 
			 pre.style.color = `${color}`;
			 pre.innerHTML = message; 
			 const outputDiv = document
                .getElementById('output');
			 outputDiv.appendChild(pre);
            
	    }

        function writeToHistory(message, color = 'black') {
			 var pre = document.createElement("p"); 
			 pre.style.wordWrap = "break-word"; 
			 pre.style.color = `${color}`;
			 pre.innerHTML = message; 
             const historyDiv = document
                .getElementById('history');
             historyDiv.appendChild(pre);
	    }

        function clearScreen() {

             document.getElementById("output").innerHTML = "";
	    }

        function createCookie(name, value, days) {
            var expires;
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toGMTString();
            }
            else {
                expires = "";
            }
            document.cookie = name + "=" + value + expires + ";path=/";
        }

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
		
		reConnect()


    </script>
</body>

</html>
